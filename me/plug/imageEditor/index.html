<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>图像裁剪</title>
<style>
html,body { font-size:90%; font-family:georgia; color: #333; }
h1, h2, h3 { font-family: Microsoft YaHei; }
body { background:#EEE; }
h1 { font-size:4em; }
ul { list-style:none; }
.caption { text-align:center; }
.caption p { color:red; }
.list { width:240px; margin:0 auto; }
.list li { height:120px; overflow:hidden; float:left; margin-right:10px; border:solid 5px #fff; cursor:pointer; }
.list li:hover { border-color:red; }
.box { width:250px; height:250px; margin:0 auto; }
</style>
<script src="av.js"></script>
</head>
<body>
<div class="caption">
	<h1>JavaScript模拟图像裁剪</h1>
	<p>点击缩略图开始裁剪</p>
</div>
<ul class="list">
	<li>
		<form action="" class="imageEditor">
			<img width="100" src="images/img_1.jpg" alt="">
		</form>
	</li>
	<li>
		<form action="" class="imageEditor">
			<img width="100" src="images/img_2.jpg" alt="">
		</form>
	</li>
</ul>

<script>
(function() {
	//浏览器窗口的宽度和高度
	function getWindowSize() {
		if(self.innerHeight) {
			return {
				"width": self.innerWidth,
				"height": self.innerHeight
			};
		} else if(document.documentElement && document.documentElement.clientHeight) {
			return {
				"width": document.documentElement.clientWidth,
				"height": document.documentElement.clientHeight
			};
		} else if(document.body) {
			return {
				"width": document.body.clientWidth,
				"height": document.body.clientHeight
			}
		}
	}

	function getDimensions(e) {
		return {
			top: e.offsetTop,
			left: e.offsetLeft,
			width: e.offsetWidth,
			height: e.offsetHeight
		};
	}

	function setNumericStyle(e, dim, updateMessage) {
		updateMessage = updateMessage || false;
		var style = {};
		for(var i in dim) {
			if(!dim.hasOwnProperty(i)) continue;
			style[i] = (dim[i] || "0") + "px";
		}
		av.setStyle(e, style);
		if(updateMessage) {
			imageEditor.elements.cropSizeDisplay.firstChild.nodeValue = dim.width + "x" + dim.height;
		}

	}

	function imageEditor() {};
	imageEditor.info = {
		resizeCropArea: false,
		pointerStart: null,
		resizeStart: null,
		cropAreaStart: null,
		imgSrc: null
	};
	imageEditor.elements = {
		"backdrop": null,
		"editor": null,
		"resizeHandle": null,
		"cropSizeDisplay": null,
		"resize": null,
		"resizeCover": null,
		"cropArea": null,
		"resizeClone": null,
		"cropResizeHandle": null,
		"saveHandle": null,
		"cancelHandle": null
	};
	imageEditor.load = function(event) {
		var forms = av.getElementsByClassName("imageEditor", "FORM");
		for(var i = 0; i < forms.length; i++) {
			var images = forms[i].getElementsByTagName("img");
			if(!images[0]) {
				//如果表单中没有图像则跳过
				continue;
			}
			av.addHandler(images[0], "click", imageEditor.imageClick);
			forms[i].className += " imgEditorModified";
		}
	};
	imageEditor.unload = function(event) {
		document.body.removeChild(imageEditor.elements.editor);
		document.body.removeChild(imageEditor.elements.backdrop);
	};
	imageEditor.imageClick = function(event) {

		var image = new Image();
		image.src = imageEditor.info.imgSrc = this.src;
		var windowSize = getWindowSize();
		var backdrop = document.createElement("div");
		imageEditor.elements.backdrop = backdrop;
		av.setStyle(backdrop, {
			"position": "absolute",
			"background-color": "black",
			"opacity": "0.8",
			"width": "100%",
			"height": "100%",
			"z-indent": 1000,
			"filter": "alpha(opacity=80)"
		});
		setNumericStyle(backdrop, {
			"left": 0,
			"top": 0,
			"width": windowSize.width,
			"height": windowSize.height
		});
		document.body.appendChild(backdrop);
		//创建编辑器div以及包含编辑工具的GUI
		var editor = document.createElement("div");
		imageEditor.elements.editor = editor;
		av.setStyle(editor, {
			"position": "absolute",
			"z-index": 10001
		});
		setNumericStyle(editor, {
			"left": Math.ceil((windowSize.width - image.width) / 2),
			"top": Math.ceil((windowSize.height - image.height) / 2),
			"width": image.width,
			"height": image.height
		});
		document.body.appendChild(editor);
		//创建拖放手柄
		var resizeHandle = document.createElement("div");
		imageEditor.elements.resizeHandle = resizeHandle;
		av.setStyle(resizeHandle, {
			"position": "absolute",
			"background": "url(images/handles.gif) no-repeat 0 0"
		});
		setNumericStyle(resizeHandle, {
			"left": (image.width - 18),
			"top": (image.height - 18),
			"width": 28,
			"height": 28
		});
		editor.appendChild(resizeHandle);
		//创建可缩放的图像
		var resize = document.createElement("img");
		imageEditor.elements.resize = resize;
		resize.src = imageEditor.info.imgSrc;
		av.setStyle(resize, {
			"position": "absolute",
			"margin": 0,
			"padding": 0,
			"border": 0
		});
		setNumericStyle(resize, {
			"left": 0,
			"top": 0,
			"width": image.width,
			"height": image.height
		});
		editor.appendChild(resize);
		//创建半透明的蒙板
		var resizeCover = document.createElement("div");
		imageEditor.elements.resizeCover = resizeCover;
		av.setStyle(resizeCover, {
			"position": "absolute",
			"background-color": "black",
			"opacity": 0.5,
			"fliter": "alpha(opacity=50)"
		});
		setNumericStyle(resizeCover, {
			"left": 0,
			"top": 0,
			"width": image.width,
			"height": image.height
		});
		editor.appendChild(resizeCover);
		//创建裁剪大小显示区域
		var cropSizeDisplay = document.createElement("div");
		imageEditor.elements.cropSizeDisplay = cropSizeDisplay;
		av.setStyle(cropSizeDisplay, {
			"position": "absolute",
			"background-color": "black",
			"color": "white"
		});
		setNumericStyle(cropSizeDisplay, {
			"left": 0,
			"top": 0,
			"font-size": 10,
			"line-height": 10,
			"padding": 4
		})
		cropSizeDisplay.appendChild(document.createTextNode("size"));
		//创建裁剪区域容器
		var cropArea = document.createElement("div");
		imageEditor.elements.cropArea = cropArea;
		av.setStyle(cropArea, {
			"position": "absolute",
			"overflow": "hidden",
			"background-color": "transparent"
		});
		setNumericStyle(cropArea, {
			"left": 0,
			"top": 0,
			"width": image.width,
			"height": image.height
		}, true);
		editor.appendChild(cropArea);
		var resizeClone = resize.cloneNode(false);
		imageEditor.elements.resizeClone = resizeClone;
		cropArea.appendChild(resizeClone);
		cropArea.appendChild(cropSizeDisplay);

		//创建裁剪缩放手柄
		var cropResizeHandle = document.createElement("div");
		imageEditor.elements.cropResizeHandle = cropResizeHandle;
		av.setStyle(cropResizeHandle, {
			"position": "absolute",
			"background": "transparent url(images/handles.gif) no-repeat 0 0"
		});
		setNumericStyle(cropResizeHandle, {
			"right": 0,
			"bottom": 0,
			"width": 18,
			"height": 18
		});
		cropArea.appendChild(cropResizeHandle);
		//创建保存手柄
		var saveHandle = document.createElement("div");
		imageEditor.elements.saveHandle = saveHandle;
		av.setStyle(saveHandle, {
			"position": "absolute",
			"background": "url(images/handles.gif) no-repeat -40px 0"
		});
		setNumericStyle(saveHandle, {
			"left": 0,
			"bottom": 0,
			"width": 16,
			"height": 18
		});
		cropArea.appendChild(saveHandle);
		//创建取消手柄
		var cancelHandle = document.createElement("div");
		imageEditor.elements.cancelHandle = cancelHandle;
		av.setStyle(cancelHandle, {
			"position": "absolute",
			"background": "url(images/handles.gif) no-repeat -29px -11px"
		});
		setNumericStyle(cancelHandle, {
			"right": 0,
			"top": 0,
			"width": 18,
			"height": 16
		});
		cropArea.appendChild(cancelHandle);
		//缩放手柄背景图片
		av.addHandler(resizeHandle, "mouseover", function(event) {
			av.setStyle(this, {
				"background-position": "0 -29px"
			});
		})
		av.addHandler(resizeHandle, "mouseout", function(event) {
			av.setStyle(this, {
				"background-position": "0 0"
			});
		})
		//裁剪手柄背景图片
		av.addHandler(cropResizeHandle, "mouseover", function(event) {
			av.setStyle(this, {
				"background-position": "0 -29px"
			});
		})
		av.addHandler(cropResizeHandle, "mouseout", function(event) {
			av.setStyle(this, {
				"background-position": "0 0"
			});
		})
		//保存手柄背景图片
		av.addHandler(saveHandle, "mouseover", function(event) {
			av.setStyle(this, {
				"background-position": "-40px -29px"
			});
		})
		av.addHandler(saveHandle, "mouseout", function(event) {
			av.setStyle(this, {
				"background-position": "-40px 0"
			});
		})
		//取消手柄背景图片
		av.addHandler(cancelHandle, "mouseover", function(event) {
			av.setStyle(this, {
				"background-position": "-29px -40px"
			});
		})
		av.addHandler(cancelHandle, "mouseout", function(event) {
			av.setStyle(this, {
				"background-position": "-29px -11px"
			});
		})
		//绑定图像缩放
		av.addHandler(resizeHandle, "mousedown", imageEditor.resizeMouseDown);
		//绑定裁剪区域拖动
		av.addHandler(cropArea, "mousedown", imageEditor.cropMouseDown);
		//绑定裁剪区域缩放
		av.addHandler(cropResizeHandle, "mousedown", function(event) {
			imageEditor.info.resizeCropArea = true;
		});
		//防止保存手柄启动裁剪拖放事件流
		av.addHandler(saveHandle, "mousedown", function(event) {
			av.stopPropagation(event);
		});
		av.addHandler(saveHandle, "click", imageEditor.saveClick);
		av.addHandler(cropArea, "dblclick", imageEditor.saveClick);
		av.addHandler(cancelHandle, "mousedown", function(event) {
			av.stopPropagation(event);
		})
		av.addHandler(cancelHandle, "click", imageEditor.cancelClick);
		//如果窗口大小改变怎调整背景遮罩的大小
		av.addHandler(window, "resize", function(event) {
			var windowSize = getWindowSize();
			setNumericStyle(backdrop, {
				"left": 0,
				"top": 0,
				"width": windowSize.width,
				"height": windowSize.height
			});
		});
	};
	imageEditor.resizeMouseDown = function(event) {
		imageEditor.info.pointerStart = av.getPointerPositionInDocument(event);
		imageEditor.info.resizeStart = getDimensions(imageEditor.elements.resize);
		imageEditor.info.cropAreaStart = getDimensions(imageEditor.elements.cropArea);
		av.addHandler(document, "mousemove", imageEditor.resizeMouseMove);
		av.addHandler(document, "mouseup", imageEditor.resizeMouseUp);
		av.stopPropagation(event);
		av.preventDefault(event);
	};
	av.addHandler(document, "mousemove", imageEditor.resizeMouseMove);
	imageEditor.resizeMouseMove = function(event) {
		var info = imageEditor.info;
		var pointer = av.getPointerPositionInDocument(event);
		var width = (info.resizeStart.width + pointer.x - info.pointerStart.x);
		var height = (info.resizeStart.height + pointer.y - info.pointerStart.y);
		if(width < 42) {
			width = 42;
		}
		if(height < 42) {
			height = 42;
		}
		//计算基于原始宽的百分比
		var widthPercent = (width / info.resizeStart.width);
		var heightPercent = (height / info.resizeStart.height);
		//如果按下了Shift键，则按比例缩放
		if(av.getEvent(event).shiftKey) {
			if(widthPercent > heightPercent) {
				heightPercent = widthPercent
				height = Math.ceil(info.resizeStart.height * heightPercent);
			} else {
				widthPercent = heightPercent;
				width = Math.ceil(info.resizeStart.width * widthPercent);
			}
		}
		var cropWidth = Math.ceil(info.cropAreaStart.width * widthPercent);
		var cropHeight = Math.ceil(info.cropAreaStart.height * heightPercent);
		var cropLeft = Math.ceil(info.cropAreaStart.left * widthPercent);
		var cropTop = Math.ceil(info.cropAreaStart.top * heightPercent);
		//应用样式
		setNumericStyle(imageEditor.elements.resize, {
			"width": width,
			"height": height
		});
		setNumericStyle(imageEditor.elements.resizeCover, {
			"width": width,
			"height": height
		});
		setNumericStyle(imageEditor.elements.resizeHandle, {
			"left": (width - 18),
			"top": (height - 18)
		});
		setNumericStyle(imageEditor.elements.cropArea, {
			"left": cropLeft,
			"top": cropTop,
			"width": cropWidth,
			"height": height
		});
		setNumericStyle(imageEditor.elements.resizeClone, {
			"left": (cropLeft * -1),
			"top": (cropTop * -1),
			"width": width,
			"height": height
		});
		//阻止事件流
		av.stopPropagation(event);
		av.preventDefault(event);
	};
	imageEditor.resizeMouseUp = function(event) {
		av.removeHandler(document, "mousemove", imageEditor.resizeMouseMove);
		av.removeHandler(document, "mouseup", imageEditor.resizeMouseUp);
		av.stopPropagation(event);
		av.preventDefault(event);
	};
	imageEditor.cropMouseDown = function(event) {
		imageEditor.info.pointerStart = av.getPointerPositionInDocument(event);
		imageEditor.info.cropAreaStart = getDimensions(imageEditor.elements.cropArea);
		var resizeStart = getDimensions(imageEditor.elements.resize);
		imageEditor.info.maxX = resizeStart.left + resizeStart.width;
		imageEditor.info.maxY = resizeStart.top + resizeStart.height;
		av.addHandler(document, "mousemove", imageEditor.cropMouseMove);
		av.addHandler(document, "mouseup", imageEditor.cropMouseUp);
		av.stopPropagation(event);
		av.preventDefault(event);
	};
	imageEditor.cropMouseMove = function(event) {

		var pointer = av.getPointerPositionInDocument(event);
		if(imageEditor.info.resizeCropArea) {
			var width = (imageEditor.info.cropAreaStart.width + pointer.x - imageEditor.info.pointerStart.x);
			var height = (imageEditor.info.cropAreaStart.height + pointer.y - imageEditor.info.pointerStart.y);
			var widthPercent = (width / imageEditor.info.cropAreaStart.width);
			var heightPercent = (height / imageEditor.info.cropAreaStart.height);
			if(av.getEvent(event).shiftKey) {
				if(widthPercent > heightPercent) {
					heightPercent = widthPercent;
					height = Math.ceil(imageEditor.info.cropAreaStart.height * heightPercent);
				} else {
					widthPercent = heightPercent;
					width = Math.ceil(imageEditor.info.cropAreaStart.width * widthPercent);
				}
			}
			if(imageEditor.info.cropAreaStart.left + width > imageEditor.info.maxX) {
				width = imageEditor.info.maxX - imageEditor.info.cropAreaStart.left;
			} else if(width < 36) {
				width = 36;
			}
			if(imageEditor.info.cropAreaStart.top + height > imageEditor.info.maxY) {
				height = imageEditor.info.maxY - imageEditor.info.cropAreaStart.top;
			} else if(height < 36) {
				height = 36;
			}
			setNumericStyle(imageEditor.elements.cropArea, {
				"width": width,
				"height": height
			}, true);
		} else {
			//移动裁剪区域
			var left = (imageEditor.info.cropAreaStart.left + pointer.x - imageEditor.info.pointerStart.x);
			var top = (imageEditor.info.cropAreaStart.top + pointer.y - imageEditor.info.pointerStart.y);
			//检查是否超出了边界
			var maxLeft = imageEditor.info.maxX - imageEditor.info.cropAreaStart.width;
			if(left < 0) {
				left = 0;
			} else if(left > maxLeft) {
				left = maxLeft;
			}
			var maxTop = imageEditor.info.maxY - imageEditor.info.cropAreaStart.height;
			if(top < 0) {
				top = 0;
			} else if(top > maxTop) {
				top = maxTop;
			}
			setNumericStyle(imageEditor.elements.cropArea, {
				"left": left,
				"top": top
			});
			setNumericStyle(imageEditor.elements.resizeClone, {
				"left": (left*-1),
				"top": (top*-1)
			});
		}
		av.stopPropagation(event);
		av.preventDefault(event);
	};
	imageEditor.cropMouseUp = function(event) {
		var event = av.getEvent(event);
		imageEditor.info.resizeCropArea = false;
		av.removeHandler(document, "mousemove", imageEditor.cropMouseMove);
		av.removeHandler(document, "mouseup", imageEditor.cropMouseUp);
		//阻止事件
		av.stopPropagation(event);
		av.preventDefault(event);
	};
	imageEditor.saveClick = function(event) {
		alert("信息将保存至服务器");
		imageEditor.unload();
	};
	imageEditor.cancelClick = function(event) {
		if(confirm("你确认要取消操作吗？")) {
			imageEditor.unload();
		}
	};
	window["av"]["imageEditor"] = imageEditor;
})();
av.imageEditor.load()
</script>
</body>
</html>